<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ballfight</title>

    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
    <!--[if lte IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.1.10/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/json3/3.3.2/json3.min.js"></script>
    <![endif]-->
    <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js"></script>
</head>
<body>
    
    <div id="connect-panel">
        <header>Connection setting</header>
        <section>
            <label>url</label>
            <input type="text" id="url" value="ws://wamp-router-sunset1995.c9users.io:8080/ws">
        </section>
        <section>
            <label>room</label>
            <input type="text" id="room" value="yourname">
        </section>
        <button id="connect">Submit</button>
    </div>

    <div id="feedback-info">
        <strong></strong>
        <button id="start-fight">Fight</button>
    </div>

    <div id="arena"></div>
    <div id="hero"></div>
    <div id="monster"></div>
    

    <script type="text/javascript">
    (function() {
        var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                    window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
        window.requestAnimationFrame = requestAnimationFrame;
    })();
    </script>
    <script type="text/javascript">
    var feedbackBlock = document.getElementById('feedback-info');
    var feedback = document.querySelector('#feedback-info > strong');
    var startFight = document.querySelector('#start-fight');
    var arenaDOM = document.getElementById('arena');
    var heroDOM = document.getElementById('hero');
    var monsterDOM = document.getElementById('monster');

    var connected = false;
    var lastState = 'first';
    var state = 'first';
    var radius = 350;
    var hero = [0, 0];
    var monster = [0, 0];




    function updateDOM(timestamp) {
        // read
        var arena = arenaDOM.getBoundingClientRect();
        var oX = document.body.getBoundingClientRect().width / 2;
        var oY = document.body.getBoundingClientRect().height / 2;
        var stateChange = lastState!=state;
        lastState = state;

        // write
        arenaDOM.style.width = (2*radius) + 'px';
        arenaDOM.style.height = (2*radius) + 'px';
        heroDOM.style.transform = 'translate(%dpx, %dpx)'.replace('%d', oX+hero[0]).replace('%d', oY+hero[1]);
        monsterDOM.style.transform = 'translate(%dpx, %dpx)'.replace('%d', oX+monster[0]).replace('%d', oY+monster[1]);
        if( stateChange ) {
            if( state === 'win' )
                feedback.innerHTML = 'Hero is winner!!!';
            else if( state === 'lose' )
                feedback.innerHTML = 'Hero is loser...';
            else
                feedback.innerHTML = state;
            feedbackBlock.style.display = (state==='')? 'none' : 'block';
        }


        requestAnimationFrame(updateDOM);
    }
    requestAnimationFrame(updateDOM);




    function connect() {
        document.querySelector('#connect-panel').style.display = 'none';
        state = 'Connecting to server...';
        
        var url = document.getElementById('url').value;
        var room = document.getElementById('room').value;

        var connection = new autobahn.Connection({
            url: url,
            realm: 'ballfight',
        });

        connection.onopen = function (session) {
            connected = true;
            state = 'Let start!!';

            session.subscribe('server.observer.'+room, function(args, kwargs, details) {
                console.log(new Uint8Array(args[0]['data']))
                var ret = msgpack.decode(new Uint8Array(args[0]['data']));
                console.log(ret)
                state = ret.state || '';
                radius = ret.radius || 0;
                hero = ret.heroPos || [0, 0];
                monster = ret.monsterPos || [0, 0];
            });
            session.publish('joinRoom', [room], {});

            startFight.style.display = 'inline-block';
            startFight.onclick = function() {
                state = '';
                session.publish('player.'+room, ['start'], {});
            };
        };

        connection.onclose = function (reason, details) {
            connected = false;
            state = 'Connection closed, please press "ctrl + shift + R"';
            startFight.style.display = 'none';
        };

        connection.open();
    }
    document.getElementById('connect').onclick = connect;
    </script>

</body>
</html>
