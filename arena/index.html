<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ballfight</title>

    <link rel="stylesheet" type="text/css" href="/arena/style.css">
    <style type="text/css">
        .mid-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
    </style>
    <script src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
</head>
<body>
    
    <div id="connect-panel">
        <header>Connection setting</header>
        <section>
            <label>url</label>
            <input type="text" id="url" value="ws://wamp-router-sunset1995.c9users.io:8080/ws">
        </section>
        <section>
            <label>room</label>
            <input type="text" id="room" value="yourname">
        </section>
        <button id="connect">Submit</button>
    </div>

    <div id="feedback-info">
        <strong></strong>
        <button id="start-fight">Fight</button>
    </div>

    <div id="arena"></div>
    <div id="hero"></div>
    <div id="monster"></div>
    

    <script type="text/javascript">
        (function() {
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                        window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;
        })();
    </script>
    <script type="text/javascript">
    var feedbackBlock = document.getElementById('feedback-info');
    var feedback = document.querySelector('#feedback-info > strong');
    var startFight = document.querySelector('#start-fight');
    var arenaDOM = document.getElementById('arena');
    var heroDOM = document.getElementById('hero');
    var monsterDOM = document.getElementById('monster');

    var connected = false;
    var lastState = 'first';
    var state = 'first';
    var radius = 350;
    var hero = [0, 0];
    var monster = [0, 0];




    function updateDOM(timestamp) {
        // read
        var arena = arenaDOM.getBoundingClientRect();
        var oX = arena.left + radius;
        var oY = arena.top + radius;
        var stateChange = lastState!=state;
        lastState = state;

        // write
        arenaDOM.style.width = (2*radius) + 'px';
        arenaDOM.style.height = (2*radius) + 'px';
        heroDOM.style.transform = 'translate(%dpx, %dpx)'.replace('%d', oX+hero[0]).replace('%d', oY+hero[1]);
        monsterDOM.style.transform = 'translate(%dpx, %dpx)'.replace('%d', oX+monster[0]).replace('%d', oY+monster[1]);
        if( stateChange ) {
            feedback.innerHTML = state;
            feedbackBlock.style.display = (state==='')? 'none' : 'block';
        }


        requestAnimationFrame(updateDOM);
    }
    requestAnimationFrame(updateDOM);




    function connect() {
        document.querySelector('#connect-panel').style.display = 'none';
        state = 'Connecting to server...';
        
        var url = document.getElementById('url').value;
        var room = document.getElementById('room').value;

        var connection = new autobahn.Connection({
            url: url,
            realm: 'ballfight',
        });

        connection.onopen = function (session) {
            connected = true;
            state = 'Let start!!';

            session.subscribe('server.'+room, function(args, kwargs, details) {
                state = kwargs.state || '';
                radius = kwargs.radius || 0;
                hero = kwargs.heroPos || [0, 0];
                monster = kwargs.monsterPos || [0, 0];
            });
            session.publish('joinRoom', [room], {});

            startFight.style.display = 'inline-block';
            startFight.onclick = function() {
                state = '';
                session.publish('player.'+room, ['start'], {});
            };
        };

        connection.onclose = function (reason, details) {
            connected = false;
            state = 'Connection closed, please press "ctrl + shift + R"';
            startFight.style.display = 'none';
        };

        connection.open();
    }
    document.getElementById('connect').onclick = connect;
    </script>

</body>
</html>
