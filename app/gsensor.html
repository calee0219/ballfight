<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gravity sensor</title>

    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://autobahn.s3.amazonaws.com/autobahnjs/latest/autobahn.min.jgz"></script>
</head>
<body>

    <div id="connect-panel">
        <header>Connection setting</header>
        <section>
            <label>url</label>
            <input type="text" id="url" value="ws://wamp-router-sunset1995.c9users.io:8080/ws">
        </section>
        <section>
            <label>room</label>
            <input type="text" id="room" value="yourname">
        </section>
        <section>
            <button id="connect-hero">Hero</button>
            <button id="connect-monster">Monster</button>
        </section>
    </div>

    <div id="game-panel">
        <strong></strong>
    </div>

    
    <script type="text/javascript">
        (function() {
            var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                                        window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
            window.requestAnimationFrame = requestAnimationFrame;
        })();
    </script>
    <script>
    document.getElementById('game-panel').style.display = 'block';
    document.getElementById('game-panel').style.opacity = '1';
    document.getElementById('url').value = 'ws://'+location.hostname+':8080/ws';
    var feedback = document.querySelector('#game-panel > strong');

    var url = '';
    var room = '';
    var player = 'hero';
    var session = null;
    var connected = false;
    function connect() {
        document.querySelector('#connect-panel').style.display = 'none';
        feedback.innerHTML = 'Connecting to server...';
        
        url = document.getElementById('url').value;
        room = document.getElementById('room').value;

        var connection = new autobahn.Connection({
            url: url,
            realm: 'ballfight',
        });

        connection.onopen = function (ses) {
            connected = true;
            feedback.innerHTML = 'Connection success';
            session = ses;
        };

        connection.onclose = function (reason, details) {
            connected = false;
            feedback.innerHTML = 'Connection closed, please refresh this page';
        };

        connection.open();
    }
    document.getElementById('connect-hero').onclick = connect;
    document.getElementById('connect-monster').onclick = function() {
        player = 'monster';
        connect();
    };



    // g-sensor
    var gsensor = [0, 0];
    window.ondevicemotion = function(event) {
        gsensor[0] = event.accelerationIncludingGravity.x || 0;  
        gsensor[1] = event.accelerationIncludingGravity.y || 0;

        gsensor[0] = parseInt(gsensor[0]*10, 10);
        gsensor[1] = parseInt(gsensor[1]*10, 10);
    }



    // sender
    var interval = 50;
    var lastTimestamp = null;
    function sender(timestamp) {
        if( lastTimestamp===null )
            lastTimestamp = timestamp;

        if( timestamp-lastTimestamp > interval && connected ) {
            session.publish(room+'.gsensor.'+player, gsensor, {});
            feedback.innerHTML = gsensor[0] + '<br>' + gsensor[1];
            lastTimestamp = timestamp;
        }

        requestAnimationFrame(sender);
    }
    requestAnimationFrame(sender);
    </script>
</body>
</html>
